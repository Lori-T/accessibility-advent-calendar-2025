{% extends "/layouts/main.html" %}

{% set pageTitle = "Day 4: Check link purpose on the Naughty and Nice List Viewer" %}
{% set currentDayNumber = 4 %}

{% block beforeContent %}
  {{ govukBackLink({
      text: "Back to home",
      href: "/"
  }) }}
{% endblock %}

{% block content %}

<div id="day-content">

<h1 class="govuk-heading-l">Day 4: Check link purpose on the Naughty and Nice List Viewer</h1>

<p class="govuk-body">
  The <strong>Department of Elfish Affairs</strong> has been reviewing the
  <strong>Naughty and Nice List Viewer</strong>, a tool used by Santa’s team to
  review behaviour records from across the year.
</p>

<p class="govuk-body">
  During testing, several elves reported that it was hard to understand where
  some links would take them — especially when navigating using a screen reader
  or viewing links out of context.
</p>

<h2 class="govuk-heading-m">Your mission today</h2>
<p class="govuk-body">
  Check that links clearly describe their purpose.
</p>

<h2 class="govuk-heading-m">Quick 5-minute check</h2>
<ul class="govuk-list govuk-list--bullet">
  <li>link text should describe the destination or action</li>
  <li>avoid vague text like <q>click here</q> or <q>more</q></li>
  <li>assume users may encounter links out of context</li>
  <li>surrounding text can help, but links should still be meaningful</li>
</ul>

<hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

<h2 class="govuk-heading-m">Examine the Naughty and Nice List Viewer</h2>
<p class="govuk-body">
  Below is a simplified extract from the Naughty and Nice List Viewer.
  One link has a deliberate accessibility issue.
</p>

<div class="govuk-!-padding-4 govuk-!-margin-bottom-4"
     style="background:#f7f7f7; border-radius:8px; max-width:640px;">

  <p class="govuk-body">
    <strong>Eve Snowball</strong><br>
    Behaviour rating: Mostly nice<br>
    <a href="#" onclick="openResultDialog('eve'); return false;">
      View Eve Snowball’s full behaviour record
    </a>
  </p>

  <p class="govuk-body">
    <strong>Buddy the Elf</strong><br>
    Behaviour rating: Under review<br>
    <a href="#" onclick="openResultDialog('buddy'); return false;">
      Click here
    </a> ❌
  </p>

  <p class="govuk-body">
    <strong>Holly Tinseltoe Frost</strong><br>
    Behaviour rating: Nice<br>
    <a href="#" onclick="openResultDialog('holly'); return false;">
      View Holly Tinseltoe Frost’s behaviour record
    </a>
  </p>

</div>

<h2 class="govuk-heading-m">What this checks for</h2>
<p class="govuk-body">
  <strong>2.4.4 link purpose (in context)</strong> – users must be able to
  understand what a link does from its text or surrounding context.
</p>

<h2 class="govuk-heading-m">Why this matters</h2>
<p class="govuk-body">
  Screen reader users often navigate by listing links on a page.
  If several links are called <q>click here</q>, it becomes impossible to tell
  them apart without extra effort.
</p>

<h2 class="govuk-heading-m">
  Finding this issue using the Workshop Accessibility Verification Engine (WAVE)
</h2>

<p class="govuk-body">
  When <a href="https://wave.webaim.org/extension/" class="govuk-link">WAVE</a> is run on a page like this,
  it can highlight links with vague or repeated text.
</p>

<p class="govuk-body">
  WAVE helps flag potential problems, but you still need to decide whether the
  link text makes sense when read on its own.
</p>

<img
  src="{{ asset_path }}images/wave4.png"
  alt="WAVE highlighting links with unclear purpose"
  style="width:25%; border-radius:8px;">

<h2 class="govuk-heading-m">Bonus challenge</h2>
<p class="govuk-body">
  Use a screen reader or browser tool to view a list of all links on the page.
  Can you immediately tell what each link does?
</p>

</div>

<!-- ACCESSIBLE RESULT DIALOG -->
<div id="result-dialog" hidden>
  <div
    role="dialog"
    aria-modal="true"
    aria-labelledby="result-title"
    aria-describedby="result-description"
    style="
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    "
  >
    <div
      id="result-dialog-content"
      tabindex="-1"
      style="
        background:#ffffff;
        padding:24px;
        border-radius:8px;
        max-width:420px;
        width:calc(100% - 40px);
      "
    >
      <h2 id="result-title" class="govuk-heading-m"></h2>
      <p id="result-description" class="govuk-body"></p>

      <button
        class="govuk-button govuk-button--secondary"
        type="button"
        onclick="closeResultDialog()">
        Close
      </button>
    </div>
  </div>
</div>

<script>
  let lastFocusedElement;

  function openResultDialog(person) {
    lastFocusedElement = document.activeElement;

    const title = document.getElementById('result-title');
    const description = document.getElementById('result-description');
    const dialog = document.getElementById('result-dialog');
    const content = document.getElementById('result-dialog-content');
    const page = document.getElementById('day-content');

    const results = {
      eve: {
        title: 'Eve Snowball — previous results',
        text: 'Mostly nice for the last 3 years. One minor snowball-related incident.'
      },
      buddy: {
        title: 'Buddy the Elf — previous results',
        text: 'Under review. Excessive cheer, rule-bending and syrup consumption.'
      },
      holly: {
        title: 'Holly Tinseltoe Frost — previous results',
        text: 'Consistently nice. Excellent teamwork and festive spirit.'
      }
    };

    title.textContent = results[person].title;
    description.textContent = results[person].text;

    dialog.removeAttribute('hidden');
    page.setAttribute('aria-hidden', 'true');
    page.setAttribute('inert', '');
    content.focus();

    document.addEventListener('keydown', trapFocus, true);
  }

  function closeResultDialog() {
    const dialog = document.getElementById('result-dialog');
    const page = document.getElementById('day-content');

    dialog.setAttribute('hidden', '');
    page.removeAttribute('aria-hidden');
    page.removeAttribute('inert');

    document.removeEventListener('keydown', trapFocus, true);
    if (lastFocusedElement) lastFocusedElement.focus();
  }

  function trapFocus(e) {
    if (e.key !== 'Tab') return;

    const focusable = document
      .getElementById('result-dialog')
      .querySelectorAll('button');

    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }

    if (e.key === 'Escape') closeResultDialog();
  }
</script>

{{ super() }}
{% endblock %}

{% block dayNavigation %}
<div class="govuk-!-margin-top-6 govuk-!-margin-bottom-6">
  <nav class="govuk-body" aria-label="Day navigation">

    {% if currentDayNumber > 1 %}
      <a class="govuk-link govuk-!-margin-right-4"
         href="/advent-calendar/day-{{ currentDayNumber - 1 }}">
        ← Previous day
      </a>
    {% endif %}

    {% if currentDayNumber < 12 %}
      <a class="govuk-link"
         href="/advent-calendar/day-{{ currentDayNumber + 1 }}">
        Next day →
      </a>
    {% endif %}

  </nav>
</div>
{% endblock %}
